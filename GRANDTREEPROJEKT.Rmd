---
title: "STIN100 Datasett 2: Analyse av genuttrykk for å forstå effektene av gammastråling på gran"
author: "Benjamin Johan Madsen & Aksel Vardeberg Skeie"
date: "16 oktober 2018"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float:
      collapsed: false
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
#Kjørte disse linjene for å gjør øvelsen litt vanskligere og mer innteresant.

#source("https://bioconductor.org/biocLite.R")
#biocLite("DESeq2")
```

```{r, include=FALSE}
library(readr)
Aksel <- readr::read_tsv("gene_expression_readcounts.tsv")
head(Aksel)
```

##1.4 Del 1: utforskning av data

##1.4.1 Hvor mange rader (gener) og kolonner (prøver) har vi i tabellen?

Vi bruker funskjonene ```nrow``` og ```ncol``` for å telle opp antall rader og kolonner. Det er 21 rader og 66069 rader i tabellen *gene_expression_readcounts.tsv.*  
```{r,}
#Dette svarer på spørsmål 1

Antall_rader <- nrow(Aksel)
Antall_kolonner <- ncol(Aksel)
```

##1.4.2 Skriv en kode som teller hvor mange replikater vi har per behandling (dvs stråledose) basert på kolonnenavnene?

```{r}
library(tidyr)
#Dette svarer på spørsmål 2
readCount <- colSums(Aksel[,-1])

d <- data.frame(navn = names(readCount),read = as.numeric(readCount))
d <- separate(d, navn, into=c('dosage', 'replicate'), sep= "-", remove = FALSE)

max(d$replicate, na.rm = TRUE)
```

##1.4.3 Bruk ggplot() + geom_bar(stat="identity") til å visualisere antall RNAseq reads vi har sekvensert for hver prøve i hver behandling.
```{r}
#Dette svarer på spørsmål 3, readcount har ingen funksjon

readCount <- colSums(Aksel[,-1])
readCount

samplecols = c(G0="lightgrey", G1="grey", G10="darkgrey", G40="red", G100="darkred")

library(ggplot2)
ggplot(d,aes(x=navn,y=read,fill = dosage)) + geom_bar(stat="identity") + scale_fill_manual(values = samplecols)
```

##1.4.4 Hvor mange gener har 0 (dvs ikke målbart genuttrykk) i minst en behandling?

```{r}
#Dette svarer på spørsmål 4

library(dplyr)

Stack_col <- gather(data=Aksel, key= sample, value = uttrykk, -geneID) %>% group_by(geneID) %>% summarise(zeroTPM=  sum(uttrykk == 0))

mytable <- table(Stack_col$zeroTPM) 

sum(mytable[2:21]) #Hvor mange gener har 0 (dvs ikke målbart genuttrykk) i minst en behandling?  
```

##1.4.5 Hvor mange gener har 0 i alle behandlinger?

```{r}
#Dette svarer på spørsmål 5

sum(mytable[21])#Hvor mange gener har 0 i alle behandlinger?
```

##1.4.6 Hva slags biologiske tolkninger kan vi gjøre om gener vi ikke kan måle genuttrykket til? 

Om gener der det finnes få eller ingen data på genets reads kan vi enten forstå det sånn at genet ikke blir påvirket av stråling eller ikke er skrudd på. Det kan også være at genmengden som ble sekvensert ikke var tilstrekkelig for å få en full lesning, og genet blir dermed regnet som ikke påvirket


##1.5 Normalisering av genuttrykksdata for variable datamengder per prøve (antall reads)

##1.5.1.1 Hva er det høyest målte genuttrykket vi har i tabellen med normaliserte data? (hvilket gen?)

```{r}
genuttrykkTPM <- readr::read_tsv("gene_expression_TPM.tsv")

library(tidyverse)

d.tidy <- genuttrykkTPM %>% 
  as_tibble %>% 
  gather(kolonne, tpm, -geneID) %>% 
  separate(kolonne, sep = '-' , into = c("dose", "rep")) %>% 
  mutate(dose = dose %>% str_sub(2) %>% as.numeric)

d.tidy[which.max(d.tidy$tpm),]

```

Vi kan se her at *MA_183668g0010* er det høyest målete genutrykket.  

##1.5.2.1 Hva er gjennomsnittet/median av genuttrykk i tabellen?
```{r}
mean(d.tidy$tpm)
```

Dette er genomsnittsverdien av genuttrykk i tabellen.

##1.5.3.1 Bruk geom_histogram til å visualisere fordelingen av genuttrykksnivå 

```{r}
library(ggplot2)

ggplot(d.tidy, aes(log2(tpm+1))) + geom_histogram() 

#legger til pluss en til alle veridene for å få med 0 veridene. På x-aksen ser man verdien kolonnen har mens på y aksen ser man antall celler i colonnen tpm som har den verdien. Ignorer bin-width 
```

##1.6 Del 2. Kvalitetskontroll av data

##1.6.1 PCA
```{r}
#1. Transformer genutrykkTPM til en matris 
genuttrykkTPM_matriks <- data.matrix(genuttrykkTPM[,-1], rownames.force = NA)

#2. Log transformer genutrykkTPM
genuttrykkTPM_matriks_log2 <- log2(genuttrykkTPM_matriks+1)

#3. Bruk "prcomp" og lagre resultatet som i object som heter "pca" 
pca <- prcomp(t(genuttrykkTPM_matriks_log2))
pca$x

percentVar <- pca$sdev^2/sum(pca$sdev^2)

library(tidyverse) 
sampleMeta <-   tibble(sampleID = colnames(genuttrykkTPM)[-1]) %>%
  separate(sampleID, c("dosage", "replicate"), sep="-", remove = F) %>%
  mutate(dosage=factor(dosage, levels = unique(dosage)))

pcaTbl <-
  as_tibble(pca$x[,1:2]) %>%
  mutate(sampleID=rownames(pca$x)) %>%
  left_join(sampleMeta, by="sampleID")
write_tsv(pcaTbl,"pcaTbl.tsv")

pcaTbl <- read.table("pcaTbl.tsv", header = TRUE, check.names = FALSE, stringsAsFactors = FALSE)
radiationColor <- c(G0="#000000",G1="#1b9b07",G10="#dbd700",G40="#ff9d00",G100="#ff0000")
radiationLabels <- c(G0="0mGy",G1="1mGy",G10="10mGy",G40="40mGy",G100="100mGy")

library(ggrepel); library(ggplot2)
ggplot(pcaTbl, aes(x=PC1,y=PC2,color=dosage, label=sampleID)) +
  xlab(paste0('PC1 (', round(percentVar[1], 2)*100, '% of variance)')) +
  ylab(paste0('PC2 (', round(percentVar[2], 2)*100, '% of variance)')) +
  geom_point() +
  geom_text_repel() + # krever ggrepel pakken
  scale_color_manual(values = radiationColor,labels = radiationLabels) +
  theme_bw()
```

##1.6.2 Klyngeanalyse med heatmap
```{r}
library(dplyr)
library(tidyverse)
genuttrykk_varians <- genuttrykkTPM %>%
  gather(Sample, Uttrykk, -1) %>%
  group_by(geneID) %>%
  summarise(Varians = var(log(1+Uttrykk))) %>%
  arrange(desc(Varians)) %>% 
  top_n(n = 5000, wt = Varians) -> genuttrykk_varians_5000

data.for.heatmap <- filter(genuttrykkTPM, geneID %in% genuttrykk_varians_5000$geneID) #Nå har vi endelig dataen vi skal jobbe med. 

data.for.heatmap.matrix <- data.matrix(data.for.heatmap[,-1], rownames.force = NA) #Gjør det om til en matrix og fjerner kolonnen for geneID ettersom den er ikke numerisk 

data.for.heatmap.matrix.log <- log(data.for.heatmap.matrix + 1) #Log transformer genutrykkTPM

data.for.heatmap.matrix.log.scaled <- scale(data.for.heatmap.matrix.log, center = TRUE, scale = TRUE) #skalerer det.

dist.var <- dist(t(data.for.heatmap.matrix.log.scaled)) #Beregn distanser mellom variablene etter skalering, dermed kan vi se vekk i fra korelasjon. 

#likhetstre for kolonnene 

dist.var.tre <- hclust(dist.var) #Vi kan visualisere likhetene i et tre. 
plot(dist.var.tre) #plotter likheten med funksjonen "plot"

#likhetstre for radene 

dist.obs <- dist(data.for.heatmap.matrix.log.scaled)
dist.obs.tre <- hclust(dist.obs)
plot(dist.obs.tre) #Prøv å fjern navnene på radene. 

#Sett sammen trærene for å lage et heat map 

#install.packages("gplots")

library(gplots)
heatmap.2(x = data.for.heatmap.matrix.log.scaled, 
          Rowv = as.dendrogram(dist.obs.tre),
          Colv = as.dendrogram(dist.var.tre),
          trace = "none",
          col = colorRampPalette(c("blue","white","red")),
          cexCol = 1,
          srtCol = 45,
          cexRow = 0.5,
          margins = c(7,3))
```

